<div class="form-container">
  <header class="form-header">
    <h2>{{ pageTitle() }}</h2>
    <button (click)="cancel()" class="btn btn-secondary btn-sm"><i class="fas fa-arrow-left"></i> Back</button>
  </header>

  @if (isLoading()) {
    <div class="loading-state"><p>Loading data...</p></div>
  } @else {
    <div class="form-content">
      
      <section class="form-section">
        <h3 class="section-title">1. Setup Position</h3>
        <div class="editor-container">
          <app-board-editor [initialFen]="fen" (fenChange)="onFenChange($event)" (validityChange)="onValidityChange($event)"></app-board-editor>
          
          @if (!isFenValid) { <div class="alert alert-danger">Invalid Piece Placement</div> }
        </div>
      </section>

      <section class="form-section" [class.disabled]="!isFenValid">
        <h3 class="section-title">2. Record Solution</h3>
        <div class="solution-layout">
          <div class="recorder-box">
            <app-solution-recorder 
              #recorder 
              [initialFen]="fen" 
              [moveList]="solutionUci().split(' ')"
              (solutionChange)="onSolutionChange($event)" 
              (currentFenChange)="onCurrentFenChange($event)">
            </app-solution-recorder>
            @if (!isFenValid) { <div class="overlay">Fix Setup to Unlock</div> }
          </div>

          <div class="meta-box">
            <div class="form-group">
              <label>Current FEN:</label>
              <input type="text" [value]="currentAnalysisFen()" class="form-control mono readonly-input" readonly />
            </div>

            <div class="form-group">
              <label>Moves (SAN or UCI):</label>
              <textarea 
                class="form-control mono" 
                [class.invalid]="!isSolutionValid()" 
                rows="2" 
                [ngModel]="solutionInput()" 
                (ngModelChange)="onManualSolutionChange($event)" 
                placeholder="e4 e5...">
              </textarea>
              @if (!isSolutionValid()) { <small class="text-danger">Invalid move sequence</small> }
            </div>

            <div class="form-group">
              <label>Preview (SAN):</label>
              <div class="san-preview">{{ solutionSan() || 'No moves recorded' }}</div>
              <button type="button" class="btn btn-warning btn-xs" (click)="clearSolution()" [disabled]="!solutionUci()">
                <i class="fas fa-undo"></i> Reset Sequence
              </button>
            </div>

            <div class="form-group">
              <label>Comment:</label>
              <textarea [(ngModel)]="comment" class="form-control" rows="2"></textarea>
              @if (comment) {
                <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px dashed #ccc; border-radius: 4px;">
                  <small style="display:block; color:#888; margin-bottom:5px;">Preview:</small>
                  <app-interactive-comment
                    [text]="comment"
                    [rootFen]="fen"
                    [solution]="solutionArray"
                    (variationSelected)="onPreviewMove($event)">
                  </app-interactive-comment>
                </div>
              }
            </div>

            <div class="actions">
              <button (click)="onSubmit()" class="btn btn-primary btn-lg" [disabled]="!isFenValid || !isSolutionValid() || !solutionUci().trim()">
                <i class="fas fa-save"></i> {{ submitLabel() }}
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  }
</div>